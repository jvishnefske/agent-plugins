# Swiss Cheese Verification Makefile
#
# Usage: make setup && make verify
#
# Reports output to $(REPORT_DIR)/: test-results.json, clippy-report.json,
# audit-report.json, coverage.json, traceability_matrix.json

.PHONY: all verify verify-quick verify-full reports clean help setup
.PHONY: validate-requirements validate-architecture validate-tdd
.PHONY: validate-implementation validate-static-analysis
.PHONY: validate-dynamic-analysis validate-review validate-safety-case
.PHONY: build test lint clippy fmt audit deny geiger
.PHONY: coverage miri fuzz bench kani prusti check-tools install-tools

# Configuration
COVERAGE_THRESHOLD ?= 70
PROPTEST_CASES ?= 10000
REPORT_DIR ?= .claude
FUZZ_DURATION ?= 60

all: verify

# =============================================================================
# Setup & Installation
# =============================================================================
setup: install-tools
	@echo "✓ Setup complete - run 'make verify'"

install-tools:
	@echo "=== Installing Tools ==="
	@rustup component add rustfmt clippy 2>/dev/null || true
	@command -v cargo-audit >/dev/null || cargo install cargo-audit
	@command -v cargo-deny >/dev/null || cargo install cargo-deny
	@command -v cargo-geiger >/dev/null || cargo install cargo-geiger
	@command -v cargo-llvm-cov >/dev/null || cargo install cargo-llvm-cov
	@rustup toolchain install nightly 2>/dev/null || true
	@rustup +nightly component add miri 2>/dev/null || true
	@echo "✓ Tools installed"

check-tools:
	@echo "=== Tool Status ==="
	@for tool in clippy fmt audit deny geiger llvm-cov tarpaulin kani fuzz flamegraph; do \
		printf "cargo-%-12s " "$$tool:" && (cargo $$tool --version 2>/dev/null || echo "not installed"); \
	done
	@printf "cargo-%-12s " "miri:" && (cargo +nightly miri --version 2>/dev/null || echo "not installed")

# =============================================================================
# Top-Level Targets
# =============================================================================
verify: validate-requirements validate-architecture validate-tdd validate-implementation \
        validate-static-analysis validate-dynamic-analysis validate-review validate-safety-case
	@echo "✓ All verification passed"

verify-quick: lint test
	@echo "✓ Quick verification passed"

verify-full: verify kani prusti
	@echo "✓ Full verification passed"

reports: $(REPORT_DIR)
	@echo "=== Generating Reports ==="
	@cargo test --all-features -- -Z unstable-options --format json 2>/dev/null > $(REPORT_DIR)/test-results.json || true
	@cargo clippy --all-targets --all-features --message-format=json 2>/dev/null > $(REPORT_DIR)/clippy-report.json || true
	@command -v cargo-audit >/dev/null && cargo audit --json > $(REPORT_DIR)/audit-report.json 2>/dev/null || true
	@command -v cargo-llvm-cov >/dev/null && cargo llvm-cov --all-features --json --output-path $(REPORT_DIR)/coverage.json || true
	@command -v cargo-geiger >/dev/null && cargo geiger --all-features 2>&1 > $(REPORT_DIR)/geiger-report.txt || true
	@$(MAKE) -s traceability-report
	@echo "✓ Reports in $(REPORT_DIR)/"

$(REPORT_DIR):
	@mkdir -p $(REPORT_DIR)

# =============================================================================
# Layer 1-3: Requirements, Architecture, TDD
# =============================================================================
validate-requirements:
	@echo "=== Layer 1: Requirements ==="
	@test -f design.toml || (echo "ERROR: design.toml not found" && exit 1)
	@python3 -c "import tomllib; d=tomllib.load(open('design.toml','rb')); \
		missing=[r['id'] for r in d.get('requirements',[]) if not r.get('acceptance_criteria')]; \
		exit(1) if missing else print('✓ Requirements valid')" || exit 1

validate-architecture:
	@echo "=== Layer 2: Architecture ==="
	@cargo metadata --format-version 1 > /dev/null
	@echo "✓ Cargo.toml valid"

validate-tdd:
	@echo "=== Layer 3: TDD ==="
	@cargo test --no-run 2>&1
	@echo "✓ Tests compile"

# =============================================================================
# Layer 4: Implementation
# =============================================================================
validate-implementation: build test
	@echo "✓ Implementation validated"

build:
	@cargo build --all-targets

test:
	@cargo test --all-features

# =============================================================================
# Layer 5: Static Analysis
# =============================================================================
validate-static-analysis: clippy audit deny geiger
	@echo "✓ Static analysis complete"

lint: clippy fmt
	@echo "✓ Lint complete"

clippy:
	@cargo clippy --all-targets --all-features -- -D warnings

fmt:
	@cargo fmt --check || (echo "Run 'cargo fmt' to fix" && exit 1)

audit:
	@command -v cargo-audit >/dev/null && cargo audit || echo "cargo-audit not installed"

deny:
	@command -v cargo-deny >/dev/null && [ -f deny.toml ] && cargo deny check || true

geiger:
	@command -v cargo-geiger >/dev/null && cargo geiger --all-features || true

# =============================================================================
# Layer 6: Formal Verification
# =============================================================================
kani:
	@command -v cargo-kani >/dev/null && cargo kani || echo "Kani not installed"

prusti:
	@command -v cargo-prusti >/dev/null && cargo prusti || echo "Prusti not installed"

# =============================================================================
# Layer 7: Dynamic Analysis
# =============================================================================
validate-dynamic-analysis: miri coverage
	@echo "✓ Dynamic analysis complete"

miri:
	@rustup run nightly cargo miri test 2>&1 || echo "Miri unavailable"

coverage: $(REPORT_DIR)
	@command -v cargo-llvm-cov >/dev/null && \
		cargo llvm-cov --all-features --json --output-path $(REPORT_DIR)/coverage.json && \
		cargo llvm-cov report --fail-under-lines $(COVERAGE_THRESHOLD) || \
		echo "Coverage check skipped"

fuzz:
	@command -v cargo-fuzz >/dev/null && [ -d fuzz ] && \
		cargo +nightly fuzz run $(FUZZ_TARGET) -- -max_total_time=$(FUZZ_DURATION) || \
		echo "Fuzzing unavailable"

bench:
	@cargo bench || true

# =============================================================================
# Layer 8-9: Review & Safety Case
# =============================================================================
validate-review:
	@echo "=== Layer 8: Review ==="
	@test -f REVIEW.md -o -f .claude/review.md || echo "No review docs"
	@echo "✓ Review checked"

validate-safety-case: traceability-report
	@echo "=== Layer 9: Safety Case ==="
	@echo "✓ Safety case assembled"

traceability-report: $(REPORT_DIR)
	@python3 -c "\
import json, tomllib; from pathlib import Path; \
design = tomllib.load(open('design.toml','rb')) if Path('design.toml').exists() else {}; \
reqs = {r['id']:r for r in design.get('requirements',[]) if 'id' in r}; \
covered = 0; matrix = {'requirements':[], 'summary':{}}; \
for rid,req in reqs.items(): \
    matrix['requirements'].append({'id':rid,'title':req.get('title','')}); \
matrix['summary'] = {'total':len(reqs),'covered':covered}; \
Path('$(REPORT_DIR)/traceability_matrix.json').write_text(json.dumps(matrix,indent=2)); \
print(f'✓ Traceability: {len(reqs)} requirements')"

# =============================================================================
# Utilities
# =============================================================================
clean:
	@rm -rf target $(REPORT_DIR)/*.json $(REPORT_DIR)/*.txt
	@echo "✓ Clean"

help:
	@echo "Usage: make [target]"
	@echo ""
	@echo "Setup:     setup, install-tools, check-tools"
	@echo "Verify:    verify, verify-quick, verify-full"
	@echo "Reports:   reports (JSON output to $(REPORT_DIR)/)"
	@echo "Lint:      lint, clippy, fmt, audit, deny, geiger"
	@echo "Test:      test, build, miri, fuzz, bench, coverage"
	@echo "Formal:    kani, prusti"
	@echo "Gates:     validate-{requirements,architecture,tdd,implementation,"
	@echo "           static-analysis,dynamic-analysis,review,safety-case}"
	@echo ""
	@echo "Config: COVERAGE_THRESHOLD=$(COVERAGE_THRESHOLD) REPORT_DIR=$(REPORT_DIR)"
